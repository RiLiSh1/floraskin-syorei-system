<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>florasKIN 症例保存フォーム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .form-header {
            background-color: #4caf50;
            color: white;
            padding: 30px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .form-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .form-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .form-body {
            background-color: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4caf50;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .required {
            color: #d32f2f;
            margin-left: 4px;
        }
        
        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #4caf50;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-text {
            font-weight: normal;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        .file-upload-label {
            display: block;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-label:hover {
            background-color: #e9ecef;
            border-color: #4caf50;
        }
        
        .image-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .image-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .add-session-btn {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .add-session-btn:hover {
            background-color: #45a049;
        }
        
        .remove-session-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-section {
            position: relative;
        }
        
        .preview-image {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border-radius: 5px;
        }
        
        .image-angle-section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #fafbfc;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        /* 画像編集モーダル */
        .image-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow: auto;
        }
        
        .image-editor-content {
            background-color: white;
            margin: 20px auto;
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            position: relative;
            padding: 20px;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .editor-title {
            font-size: 18px;
            font-weight: bold;
            color: #4caf50;
        }
        
        .editor-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .editor-close:hover {
            color: #4caf50;
        }
        
        .editor-canvas-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            max-height: 60vh;
            overflow: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .editor-canvas {
            display: block;
            max-width: 100%;
            height: auto;
            cursor: crosshair;
        }
        
        .editor-controls {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .editor-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .editor-button.primary {
            background-color: #4caf50;
            color: white;
        }
        
        .editor-button.primary:hover {
            background-color: #45a049;
        }
        
        .editor-button.secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .editor-button.secondary:hover {
            background-color: #e0e0e0;
        }
        
        .opacity-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .opacity-slider {
            width: 100px;
        }
        
        .selection-info {
            color: #666;
            font-size: 12px;
            margin-left: 15px;
        }
        
        .submit-button {
            background-color: #4caf50;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin: 30px auto 0;
            transition: background-color 0.3s;
        }
        
        .submit-button:hover {
            background-color: #45a049;
        }
        
        .customer-check {
            margin-top: 10px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        
        .customer-check.warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        .customer-check.error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }
        
        .customer-check.success {
            background-color: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }
        
        .customer-check strong {
            display: block;
            margin-bottom: 8px;
        }
        
        .customer-check-actions {
            margin-top: 10px;
        }
        
        .customer-check-actions a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .customer-check-actions a:hover {
            text-decoration: underline;
        }
        
        .check-button {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .check-button:hover {
            background-color: #138496;
        }
        
        .check-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        /* タブレット */
        @media (max-width: 1024px) {
            .container {
                padding: 15px;
            }
            
            .form-header {
                padding: 25px;
            }
            
            .form-body {
                padding: 25px;
            }
        }
        
        /* スマホ (横向き) */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .form-header {
                padding: 22px;
            }
            
            .form-body {
                padding: 22px;
            }
            
            .image-row {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .session-info {
                grid-template-columns: 1fr;
            }
        }
        
        /* スマホ (縦向き) */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .form-header {
                padding: 20px;
            }
            
            .form-header h1 {
                font-size: 20px;
            }
            
            .form-header p {
                font-size: 13px;
            }
            
            .form-body {
                padding: 20px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            input[type="text"],
            input[type="date"],
            select {
                font-size: 16px;
                padding: 12px 15px;
            }
            
            .submit-button {
                padding: 12px 30px;
                font-size: 15px;
            }
        }
        
        .header {
            position: fixed;
            top: 0;
            right: 0;
            background-color: rgba(255,255,255,0.9);
            padding: 15px 20px;
            border-radius: 0 0 0 10px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            font-size: 14px;
            color: #666;
        }
        
        .logout-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        
        .logout-btn:hover {
            background-color: #d32f2f;
        }
    </style>
     <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getStorage, ref, uploadBytes, getDownloadURL } from
  'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA9vU3pzzyqJ2dcIfRchzUldgBbaKct08c",
    authDomain: "floraskin-syorei-system.firebaseapp.com",
    projectId: "floraskin-syorei-system",
    storageBucket: "floraskin-syorei-system.appspot.com",
    messagingSenderId: "990675543914",
    appId: "1:990675543914:web:e2f1aa1ed5d7895044a713"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);

  window.uploadImageToFirebase = async function(file, path) {
      try {
          const storageRef = ref(storage, `images/${path}`);
          const snapshot = await uploadBytes(storageRef, file);
          const downloadURL = await getDownloadURL(snapshot.ref);
          return downloadURL;
      } catch (error) {
          console.error('写真アップロードエラー:', error);
          throw error;
      }
  };
  </script>
</head>
<body>
    <div class="header">
        <div class="user-info" id="userInfo"></div>
        <button class="logout-btn" onclick="logout()">ログアウト</button>
    </div>
    
    <div class="container">
        <form id="saveForm">
            <div class="form-header">
                <h1>florasKIN 症例保存フォーム</h1>
                <p>お客様の症例画像と基本情報を簡単に保存できます。</p>
                <p>【入力時間の目安】約3〜5分</p>
            </div>
            
            <div class="form-body">
                <div class="form-section">
                    <h2 class="section-title">基本情報</h2>
                    
                    <div class="form-group">
                        <label>症例区分</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="normalCase" name="normalCase" value="true" checked>
                                <span class="checkbox-text">通常症例</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="adverseReaction" name="adverseReaction" value="true">
                                <span class="checkbox-text">好転反応</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="complaint" name="complaint" value="true">
                                <span class="checkbox-text">クレーム</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerNumber">顧客番号<span class="required">*</span></label>
                        <input type="text" id="customerNumber" name="customerNumber" required placeholder="例：FK-001234" onblur="checkDuplicateCustomer()" oninput="clearCustomerCheck()">
                        <button type="button" class="check-button" onclick="checkDuplicateCustomer()" id="checkButton">重複チェック</button>
                        
                        <div id="customerCheckResult" class="customer-check">
                            <!-- チェック結果がここに表示されます -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="store">店舗<span class="required">*</span></label>
                        <select id="store" name="store" required>
                            <option value="">選択してください</option>
                            <option value="銀座Miel店">florasKIN 銀座Miel店</option>
                            <option value="銀座Blanc店">florasKIN 銀座Blanc店</option>
                            <option value="上野店">florasKIN 上野店</option>
                            <option value="恵比寿店">florasKIN 恵比寿店</option>
                            <option value="心斎橋店">florasKIN 心斎橋店</option>
                            <option value="難波店">florasKIN 難波店</option>
                            <option value="梅田店">florasKIN 梅田店</option>
                            <option value="三宮店">florasKIN 三宮店</option>
                            <option value="横浜店">florasKIN 横浜店</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="staffName">担当者名<span class="required">*</span></label>
                        <input type="text" id="staffName" name="staffName" required placeholder="例：山田 花子">
                    </div>
                    
                    <div class="form-group">
                        <label for="birthDate">お客様の生年月日<span class="required">*</span></label>
                        <input type="date" id="birthDate" name="birthDate" required onchange="calculateAgeGroup()">
                    </div>
                    
                    <div class="form-group">
                        <label for="ageGroup">年齢層（自動計算）</label>
                        <input type="text" id="ageGroup" name="ageGroup" readonly style="background-color: #f5f5f5;" placeholder="生年月日を入力すると自動計算されます">
                    </div>
                    
                    <div class="form-group">
                        <label for="concern">主な悩み<span class="required">*</span></label>
                        <input type="text" id="concern" name="concern" required placeholder="例：シミ、たるみ、乾燥など">
                    </div>
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">Before / After 画像</h2>
                    
                    <div id="imageSections">
                        <div class="image-section" id="imageSection1">
                            <h3>1回目</h3>
                            <div class="session-info">
                                <div class="form-group">
                                    <label for="sessionDate1">施術日</label>
                                    <input type="date" id="sessionDate1" name="sessionDate1">
                                </div>
                                <div class="form-group">
                                    <label for="sessionMenu1">選択したメニュー</label>
                                    <select id="sessionMenu1" name="sessionMenu1">
                                        <option value="">選択してください</option>
                                        <option value="フローラ毛穴洗浄">フローラ毛穴洗浄</option>
                                        <option value="フローラ肌質改善">フローラ肌質改善</option>
                                        <option value="フローラワックス">フローラワックス</option>
                                        <option value="その他">その他</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="sessionSolution1">使用溶剤</label>
                                    <select id="sessionSolution1" name="sessionSolution1">
                                        <option value="">選択してください</option>
                                        <option value="メラショット">メラショット</option>
                                        <option value="アドバンスト">アドバンスト</option>
                                        <option value="モーメント">モーメント</option>
                                        <option value="その他">その他</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- 正面画像 -->
                            <div class="image-angle-section">
                                <h4 style="font-size: 16px; font-weight: bold; color: #4caf50; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">正面画像</h4>
                                <div class="image-row">
                                    <div class="form-group">
                                        <label for="frontBeforeImage1">Before画像（正面）</label>
                                        <div class="file-upload">
                                            <input type="file" id="frontBeforeImage1" name="frontBeforeImage1" accept="image/*" onchange="previewImage(this, 'frontBeforeImagePreview1')">
                                            <label for="frontBeforeImage1" class="file-upload-label">
                                                正面Before画像を選択
                                            </label>
                                        </div>
                                        <img id="frontBeforeImagePreview1" class="preview-image" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="frontAfterImage1">After画像（正面）</label>
                                        <div class="file-upload">
                                            <input type="file" id="frontAfterImage1" name="frontAfterImage1" accept="image/*" onchange="previewImage(this, 'frontAfterImagePreview1')">
                                            <label for="frontAfterImage1" class="file-upload-label">
                                                正面After画像を選択
                                            </label>
                                        </div>
                                        <img id="frontAfterImagePreview1" class="preview-image" style="display: none;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右側画像 -->
                            <div class="image-angle-section">
                                <h4 style="font-size: 16px; font-weight: bold; color: #4caf50; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">右側画像（任意）</h4>
                                <div class="image-row">
                                    <div class="form-group">
                                        <label for="rightBeforeImage1">Before画像（右側）</label>
                                        <div class="file-upload">
                                            <input type="file" id="rightBeforeImage1" name="rightBeforeImage1" accept="image/*" onchange="previewImage(this, 'rightBeforeImagePreview1')">
                                            <label for="rightBeforeImage1" class="file-upload-label">
                                                右側Before画像を選択
                                            </label>
                                        </div>
                                        <img id="rightBeforeImagePreview1" class="preview-image" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="rightAfterImage1">After画像（右側）</label>
                                        <div class="file-upload">
                                            <input type="file" id="rightAfterImage1" name="rightAfterImage1" accept="image/*" onchange="previewImage(this, 'rightAfterImagePreview1')">
                                            <label for="rightAfterImage1" class="file-upload-label">
                                                右側After画像を選択
                                            </label>
                                        </div>
                                        <img id="rightAfterImagePreview1" class="preview-image" style="display: none;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 左側画像 -->
                            <div class="image-angle-section">
                                <h4 style="font-size: 16px; font-weight: bold; color: #4caf50; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">左側画像（任意）</h4>
                                <div class="image-row">
                                    <div class="form-group">
                                        <label for="leftBeforeImage1">Before画像（左側）</label>
                                        <div class="file-upload">
                                            <input type="file" id="leftBeforeImage1" name="leftBeforeImage1" accept="image/*" onchange="previewImage(this, 'leftBeforeImagePreview1')">
                                            <label for="leftBeforeImage1" class="file-upload-label">
                                                左側Before画像を選択
                                            </label>
                                        </div>
                                        <img id="leftBeforeImagePreview1" class="preview-image" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="leftAfterImage1">After画像（左側）</label>
                                        <div class="file-upload">
                                            <input type="file" id="leftAfterImage1" name="leftAfterImage1" accept="image/*" onchange="previewImage(this, 'leftAfterImagePreview1')">
                                            <label for="leftAfterImage1" class="file-upload-label">
                                                左側After画像を選択
                                            </label>
                                        </div>
                                        <img id="leftAfterImagePreview1" class="preview-image" style="display: none;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- その他画像 -->
                            <div class="image-angle-section">
                                <h4 style="font-size: 16px; font-weight: bold; color: #4caf50; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">その他画像（任意）</h4>
                                <div class="image-row">
                                    <div class="form-group">
                                        <label for="otherBeforeImage1">Before画像（その他）</label>
                                        <div class="file-upload">
                                            <input type="file" id="otherBeforeImage1" name="otherBeforeImage1" accept="image/*" onchange="previewImage(this, 'otherBeforeImagePreview1')">
                                            <label for="otherBeforeImage1" class="file-upload-label">
                                                その他Before画像を選択
                                            </label>
                                        </div>
                                        <img id="otherBeforeImagePreview1" class="preview-image" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="otherAfterImage1">After画像（その他）</label>
                                        <div class="file-upload">
                                            <input type="file" id="otherAfterImage1" name="otherAfterImage1" accept="image/*" onchange="previewImage(this, 'otherAfterImagePreview1')">
                                            <label for="otherAfterImage1" class="file-upload-label">
                                                その他After画像を選択
                                            </label>
                                        </div>
                                        <img id="otherAfterImagePreview1" class="preview-image" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="sessionNotes1">備考</label>
                            <textarea id="sessionNotes1" name="sessionNotes1" rows="3" 
                                      placeholder="この回の施術について特記事項があれば記入してください..."
                                      style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 60px; transition: border-color 0.3s;"></textarea>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="add-session-btn" onclick="addImageSection()">
                            施術回を追加
                        </button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">利用許可</h2>
                    
                    <div class="form-group">
                        <label for="secondaryUse">二次利用可否<span class="required">*</span></label>
                        <select id="secondaryUse" name="secondaryUse" required onchange="toggleSecondaryUseNote()">
                            <option value="">選択してください</option>
                            <option value="全顔OK">全顔OK（HP掲載・広告利用等での使用を許可）</option>
                            <option value="目元モザイクあればOK">目元モザイクあればOK（目元処理後の使用を許可）</option>
                            <option value="店舗内のみOK">店舗内のみOK（店舗でのご案内・相談時のみ使用可能）</option>
                            <option value="掲載NG">掲載NG（社内での症例共有・学習目的のみ）</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="secondaryUseNoteGroup" style="display: none;">
                        <label for="secondaryUseNote">備考（必要に応じて記入）</label>
                        <input type="text" id="secondaryUseNote" name="secondaryUseNote" placeholder="例：目元にモザイク処理が必要">
                    </div>
                </div>
                
                <button type="submit" class="submit-button">症例を保存</button>
            </div>
        </form>
    </div>
    
    <script>
        let imageSessionCount = 1;
        
        function calculateAgeGroup() {
            const birthDateInput = document.getElementById('birthDate');
            const ageGroupInput = document.getElementById('ageGroup');
            
            if (!birthDateInput.value) {
                ageGroupInput.value = '';
                return;
            }
            
            const birthDate = new Date(birthDateInput.value);
            const today = new Date();
            
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            let ageGroup = '';
            if (age < 20) {
                ageGroup = '10代';
            } else if (age < 30) {
                ageGroup = '20代';
            } else if (age < 40) {
                ageGroup = '30代';
            } else if (age < 50) {
                ageGroup = '40代';
            } else if (age < 60) {
                ageGroup = '50代';
            } else {
                ageGroup = '60代以上';
            }
            
            ageGroupInput.value = ageGroup;
        }
        
        function toggleSecondaryUseNote() {
            const secondaryUseSelect = document.getElementById('secondaryUse');
            const secondaryUseNoteGroup = document.getElementById('secondaryUseNoteGroup');
            
            if (secondaryUseSelect.value === '目元モザイクあればOK' || secondaryUseSelect.value === '店舗内のみOK') {
                secondaryUseNoteGroup.style.display = 'block';
            } else {
                secondaryUseNoteGroup.style.display = 'none';
                document.getElementById('secondaryUseNote').value = '';
            }
        }
        
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function checkDuplicateCustomer() {
            const customerNumber = document.getElementById('customerNumber').value.trim();
            const checkResult = document.getElementById('customerCheckResult');
            const checkButton = document.getElementById('checkButton');
            
            if (!customerNumber) {
                clearCustomerCheck();
                return;
            }
            
            // ボタンを無効化
            checkButton.disabled = true;
            checkButton.textContent = 'チェック中...';
            
            // LocalStorageから既存の症例データを取得
            const cases = JSON.parse(localStorage.getItem('floraskinCases') || '[]');
            const existingCase = cases.find(caseData => caseData.customerNumber === customerNumber);
            
            setTimeout(() => {
                checkButton.disabled = false;
                checkButton.textContent = '重複チェック';
                
                if (existingCase) {
                    // 既存の症例が見つかった場合
                    checkResult.className = 'customer-check warning';
                    checkResult.innerHTML = `
                        <strong>⚠️ この顧客番号は既に登録されています</strong>
                        既存の症例情報が見つかりました。基本情報を自動反映することができます。
                        <div class="customer-check-actions">
                            <a href="#" onclick="loadBasicData('${existingCase.id}')">基本情報を読み込む</a>
                            <a href="update.html?customerNumber=${encodeURIComponent(customerNumber)}" target="_blank">既存症例を更新する</a>
                            <a href="#" onclick="continueWithNewCase()">新規として保存する</a>
                        </div>
                    `;
                    checkResult.style.display = 'block';
                } else {
                    // 重複なしの場合
                    checkResult.className = 'customer-check success';
                    checkResult.innerHTML = `
                        <strong>✅ この顧客番号は使用可能です</strong>
                        新規症例として保存できます。
                    `;
                    checkResult.style.display = 'block';
                }
            }, 800);
        }
        
        function clearCustomerCheck() {
            const checkResult = document.getElementById('customerCheckResult');
            checkResult.style.display = 'none';
            checkResult.innerHTML = '';
        }
        
        function continueWithNewCase() {
            const checkResult = document.getElementById('customerCheckResult');
            checkResult.className = 'customer-check error';
            checkResult.innerHTML = `
                <strong>⚠️ 注意：同じ顧客番号で複数の症例が保存されます</strong>
                続行する場合は、後で症例の整理が必要になる可能性があります。
            `;
        }
        
        function loadBasicData(caseId) {
            const cases = JSON.parse(localStorage.getItem('floraskinCases') || '[]');
            
            // 同じ顧客番号の全ての症例を取得
            const customerNumber = document.getElementById('customerNumber').value.trim();
            const customerCases = cases.filter(c => c.customerNumber === customerNumber);
            
            if (customerCases.length === 0) {
                alert('前回のデータが見つかりませんでした。');
                return;
            }
            
            // 最新の症例データを取得
            const latestCase = customerCases.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
            
            // 基本情報を反映（顧客番号以外）
            document.getElementById('store').value = latestCase.store || '';
            document.getElementById('staffName').value = latestCase.staffName || '';
            document.getElementById('birthDate').value = latestCase.birthDate || '';
            document.getElementById('concern').value = latestCase.concern || '';
            
            // 生年月日から年齢層を再計算
            if (latestCase.birthDate) {
                calculateAgeGroup();
            }
            
            // 症例区分を反映
            document.getElementById('normalCase').checked = latestCase.normalCase || false;
            document.getElementById('adverseReaction').checked = latestCase.adverseReaction || false;
            document.getElementById('complaint').checked = latestCase.complaint || false;
            
            // 利用許可を反映
            document.getElementById('secondaryUse').value = latestCase.secondaryUse || '';
            if (latestCase.secondaryUseNote) {
                document.getElementById('secondaryUseNote').value = latestCase.secondaryUseNote;
                toggleSecondaryUseNote(); // 備考欄の表示制御
            }
            
            // 全ての症例から画像データを収集
            const allImages = [];
            customerCases.forEach(caseData => {
                if (caseData.images && caseData.images.length > 0) {
                    caseData.images.forEach(imageData => {
                        allImages.push({
                            ...imageData,
                            caseId: caseData.id,
                            timestamp: caseData.timestamp
                        });
                    });
                }
            });
            
            // 日付順にソート
            allImages.sort((a, b) => new Date(a.date || a.timestamp) - new Date(b.date || b.timestamp));
            
            // 既存の画像セクションをクリア
            const imageSections = document.getElementById('imageSections');
            imageSections.innerHTML = '';
            imageSessionCount = 0;
            
            // 既存の画像セクションを再作成
            if (allImages.length > 0) {
                allImages.forEach((imageData, index) => {
                    addImageSectionWithData(index + 1, imageData);
                });
            } else {
                // 画像データがない場合は1回目のセクションを作成
                addImageSectionWithData(1);
            }
            
            // 新しい施術回を追加
            addImageSectionWithData(imageSessionCount + 1);
            
            // 結果メッセージを表示
            const checkResult = document.getElementById('customerCheckResult');
            checkResult.className = 'customer-check success';
            checkResult.innerHTML = `
                <strong>✅ 前回データを読み込みました</strong>
                ${latestCase.staffName}さんの基本情報と過去の施術画像（${allImages.length}回分）を読み込みました。<br>
                新しい施術画像をアップロードして保存してください。
            `;
            
            // スクロールして画像セクションへ移動
            document.querySelector('.form-section:nth-of-type(2)').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        function addImageSection() {
            imageSessionCount++;
            addImageSectionWithData(imageSessionCount);
        }
        
        function addImageSectionWithData(sessionNumber, imageData = {}) {
            const imageSections = document.getElementById('imageSections');
            
            const newSection = document.createElement('div');
            newSection.id = `imageSection${sessionNumber}`;
            newSection.className = 'image-section';
            
            const isReadonly = imageData.caseId && imageData.caseId !== 'new';
            const readonlyAttr = isReadonly ? 'readonly' : '';
            const disabledAttr = isReadonly ? 'disabled' : '';
            
            newSection.innerHTML = `
                ${sessionNumber > 1 && !isReadonly ? `<button type="button" class="remove-session-btn" onclick="removeImageSection(${sessionNumber})">&times;</button>` : ''}
                <h3>${sessionNumber}回目${isReadonly ? ' (既存データ)' : ''}</h3>
                <div class="session-info">
                    <div class="form-group">
                        <label for="sessionDate${sessionNumber}">施術日</label>
                        <input type="date" id="sessionDate${sessionNumber}" name="sessionDate${sessionNumber}" value="${imageData.date || ''}" ${readonlyAttr}>
                    </div>
                    <div class="form-group">
                        <label for="sessionMenu${sessionNumber}">選択したメニュー</label>
                        <select id="sessionMenu${sessionNumber}" name="sessionMenu${sessionNumber}" ${disabledAttr}>
                            <option value="">選択してください</option>
                            <option value="フローラ毛穴洗浄" ${imageData.menu === 'フローラ毛穴洗浄' ? 'selected' : ''}>フローラ毛穴洗浄</option>
                            <option value="フローラ肌質改善" ${imageData.menu === 'フローラ肌質改善' ? 'selected' : ''}>フローラ肌質改善</option>
                            <option value="フローラワックス" ${imageData.menu === 'フローラワックス' ? 'selected' : ''}>フローラワックス</option>
                            <option value="その他" ${imageData.menu === 'その他' ? 'selected' : ''}>その他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sessionSolution${sessionNumber}">使用溶剤</label>
                        <select id="sessionSolution${sessionNumber}" name="sessionSolution${sessionNumber}" ${disabledAttr}>
                            <option value="">選択してください</option>
                            <option value="メラショット" ${imageData.solution === 'メラショット' ? 'selected' : ''}>メラショット</option>
                            <option value="アドバンスト" ${imageData.solution === 'アドバンスト' ? 'selected' : ''}>アドバンスト</option>
                            <option value="モーメント" ${imageData.solution === 'モーメント' ? 'selected' : ''}>モーメント</option>
                            <option value="その他" ${imageData.solution === 'その他' ? 'selected' : ''}>その他</option>
                        </select>
                    </div>
                </div>
                
                <!-- 正面画像 -->
                <div class="image-angle-section">
                    <h4 style="font-size: 16px; font-weight: bold; color: #4caf50; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">正面画像</h4>
                    <div class="image-row">
                        <div class="form-group">
                            <label for="frontBeforeImage${sessionNumber}">Before画像（正面）</label>
                            <div class="file-upload">
                                <input type="file" id="frontBeforeImage${sessionNumber}" name="frontBeforeImage${sessionNumber}" accept="image/*" onchange="previewImage(this, 'frontBeforeImagePreview${sessionNumber}')" ${disabledAttr}>
                                <label for="frontBeforeImage${sessionNumber}" class="file-upload-label">
                                    ${isReadonly ? (imageData.frontBefore || imageData.before ? '既存画像あり' : '画像なし') : (imageData.frontBefore || imageData.before ? '画像を変更' : '正面Before画像を選択')}
                                </label>
                            </div>
                            ${(imageData.frontBefore || imageData.before) && isReadonly ? '<div style="margin-top: 10px; color: #4caf50; font-size: 14px;">✓ 既存の画像があります</div>' : ''}
                            <img id="frontBeforeImagePreview${sessionNumber}" class="preview-image" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="frontAfterImage${sessionNumber}">After画像（正面）</label>
                            <div class="file-upload">
                                <input type="file" id="frontAfterImage${sessionNumber}" name="frontAfterImage${sessionNumber}" accept="image/*" onchange="previewImage(this, 'frontAfterImagePreview${sessionNumber}')" ${disabledAttr}>
                                <label for="frontAfterImage${sessionNumber}" class="file-upload-label">
                                    ${isReadonly ? (imageData.frontAfter || imageData.after ? '既存画像あり' : '画像なし') : (imageData.frontAfter || imageData.after ? '画像を変更' : '正面After画像を選択')}
                                </label>
                            </div>
                            ${(imageData.frontAfter || imageData.after) && isReadonly ? '<div style="margin-top: 10px; color: #4caf50; font-size: 14px;">✓ 既存の画像があります</div>' : ''}
                            <img id="frontAfterImagePreview${sessionNumber}" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <!-- 右側画像 -->
                <div class="image-angle-section">
                    <h4 style="font-size: 16px; font-weight: bold; color: #4caf50; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">右側画像（任意）</h4>
                    <div class="image-row">
                        <div class="form-group">
                            <label for="rightBeforeImage${sessionNumber}">Before画像（右側）</label>
                            <div class="file-upload">
                                <input type="file" id="rightBeforeImage${sessionNumber}" name="rightBeforeImage${sessionNumber}" accept="image/*" onchange="previewImage(this, 'rightBeforeImagePreview${sessionNumber}')" ${disabledAttr}>
                                <label for="rightBeforeImage${sessionNumber}" class="file-upload-label">
                                    ${isReadonly ? (imageData.rightBefore ? '既存画像あり' : '画像なし') : (imageData.rightBefore ? '画像を変更' : '右側Before画像を選択')}
                                </label>
                            </div>
                            ${imageData.rightBefore && isReadonly ? '<div style="margin-top: 10px; color: #4caf50; font-size: 14px;">✓ 既存の画像があります</div>' : ''}
                            <img id="rightBeforeImagePreview${sessionNumber}" class="preview-image" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="rightAfterImage${sessionNumber}">After画像（右側）</label>
                            <div class="file-upload">
                                <input type="file" id="rightAfterImage${sessionNumber}" name="rightAfterImage${sessionNumber}" accept="image/*" onchange="previewImage(this, 'rightAfterImagePreview${sessionNumber}')" ${disabledAttr}>
                                <label for="rightAfterImage${sessionNumber}" class="file-upload-label">
                                    ${isReadonly ? (imageData.rightAfter ? '既存画像あり' : '画像なし') : (imageData.rightAfter ? '画像を変更' : '右側After画像を選択')}
                                </label>
                            </div>
                            ${imageData.rightAfter && isReadonly ? '<div style="margin-top: 10px; color: #4caf50; font-size: 14px;">✓ 既存の画像があります</div>' : ''}
                            <img id="rightAfterImagePreview${sessionNumber}" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <!-- 左側画像 -->
                <div class="image-angle-section">
                    <h4 style="font-size: 16px; font-weight: bold; color: #4caf50; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">左側画像（任意）</h4>
                    <div class="image-row">
                        <div class="form-group">
                            <label for="leftBeforeImage${sessionNumber}">Before画像（左側）</label>
                            <div class="file-upload">
                                <input type="file" id="leftBeforeImage${sessionNumber}" name="leftBeforeImage${sessionNumber}" accept="image/*" onchange="previewImage(this, 'leftBeforeImagePreview${sessionNumber}')" ${disabledAttr}>
                                <label for="leftBeforeImage${sessionNumber}" class="file-upload-label">
                                    ${isReadonly ? (imageData.leftBefore ? '既存画像あり' : '画像なし') : (imageData.leftBefore ? '画像を変更' : '左側Before画像を選択')}
                                </label>
                            </div>
                            ${imageData.leftBefore && isReadonly ? '<div style="margin-top: 10px; color: #4caf50; font-size: 14px;">✓ 既存の画像があります</div>' : ''}
                            <img id="leftBeforeImagePreview${sessionNumber}" class="preview-image" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="leftAfterImage${sessionNumber}">After画像（左側）</label>
                            <div class="file-upload">
                                <input type="file" id="leftAfterImage${sessionNumber}" name="leftAfterImage${sessionNumber}" accept="image/*" onchange="previewImage(this, 'leftAfterImagePreview${sessionNumber}')" ${disabledAttr}>
                                <label for="leftAfterImage${sessionNumber}" class="file-upload-label">
                                    ${isReadonly ? (imageData.leftAfter ? '既存画像あり' : '画像なし') : (imageData.leftAfter ? '画像を変更' : '左側After画像を選択')}
                                </label>
                            </div>
                            ${imageData.leftAfter && isReadonly ? '<div style="margin-top: 10px; color: #4caf50; font-size: 14px;">✓ 既存の画像があります</div>' : ''}
                            <img id="leftAfterImagePreview${sessionNumber}" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <!-- その他画像 -->
                <div class="image-angle-section">
                    <h4 style="font-size: 16px; font-weight: bold; color: #4caf50; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">その他画像（任意）</h4>
                    <div class="image-row">
                        <div class="form-group">
                            <label for="otherBeforeImage${sessionNumber}">Before画像（その他）</label>
                            <div class="file-upload">
                                <input type="file" id="otherBeforeImage${sessionNumber}" name="otherBeforeImage${sessionNumber}" accept="image/*" onchange="previewImage(this, 'otherBeforeImagePreview${sessionNumber}')" ${disabledAttr}>
                                <label for="otherBeforeImage${sessionNumber}" class="file-upload-label">
                                    ${isReadonly ? (imageData.otherBefore ? '既存画像あり' : '画像なし') : (imageData.otherBefore ? '画像を変更' : 'その他Before画像を選択')}
                                </label>
                            </div>
                            ${imageData.otherBefore && isReadonly ? '<div style="margin-top: 10px; color: #4caf50; font-size: 14px;">✓ 既存の画像があります</div>' : ''}
                            <img id="otherBeforeImagePreview${sessionNumber}" class="preview-image" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="otherAfterImage${sessionNumber}">After画像（その他）</label>
                            <div class="file-upload">
                                <input type="file" id="otherAfterImage${sessionNumber}" name="otherAfterImage${sessionNumber}" accept="image/*" onchange="previewImage(this, 'otherAfterImagePreview${sessionNumber}')" ${disabledAttr}>
                                <label for="otherAfterImage${sessionNumber}" class="file-upload-label">
                                    ${isReadonly ? (imageData.otherAfter ? '既存画像あり' : '画像なし') : (imageData.otherAfter ? '画像を変更' : 'その他After画像を選択')}
                                </label>
                            </div>
                            ${imageData.otherAfter && isReadonly ? '<div style="margin-top: 10px; color: #4caf50; font-size: 14px;">✓ 既存の画像があります</div>' : ''}
                            <img id="otherAfterImagePreview${sessionNumber}" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sessionNotes${sessionNumber}">備考</label>
                    <textarea id="sessionNotes${sessionNumber}" name="sessionNotes${sessionNumber}" rows="3" 
                              placeholder="この回の施術について特記事項があれば記入してください..."
                              style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 60px; transition: border-color 0.3s;" ${readonlyAttr}>${imageData.notes || ''}</textarea>
                </div>
            `;
            
            imageSections.appendChild(newSection);
            imageSessionCount = Math.max(imageSessionCount, sessionNumber);
        }
        
        function removeImageSection(sessionId) {
            const section = document.getElementById(`imageSection${sessionId}`);
            if (section) {
                section.remove();
                renumberSections();
            }
        }
        
        function renumberSections() {
            const sections = document.querySelectorAll('.image-section');
            sections.forEach((section, index) => {
                const sessionNumber = index + 1;
                section.id = `imageSection${sessionNumber}`;
                
                const title = section.querySelector('h3');
                const titleText = title.textContent;
                if (titleText.includes('(既存データ)')) {
                    title.textContent = `${sessionNumber}回目 (既存データ)`;
                } else {
                    title.textContent = `${sessionNumber}回目`;
                }
                
                // 各種要素のIDと名前を更新
                const elements = [
                    { selector: 'input[type="date"]', prefix: 'sessionDate' },
                    { selector: 'select[id*="sessionMenu"]', prefix: 'sessionMenu' },
                    { selector: 'select[id*="sessionSolution"]', prefix: 'sessionSolution' },
                    { selector: 'input[type="file"]:first-of-type', prefix: 'beforeImage' },
                    { selector: 'input[type="file"]:last-of-type', prefix: 'afterImage' },
                    { selector: 'img:first-of-type', prefix: 'beforeImagePreview' },
                    { selector: 'img:last-of-type', prefix: 'afterImagePreview' },
                    { selector: 'textarea[id*="sessionNotes"]', prefix: 'sessionNotes' }
                ];
                
                elements.forEach(({ selector, prefix }) => {
                    const element = section.querySelector(selector);
                    if (element) {
                        element.id = `${prefix}${sessionNumber}`;
                        if (element.name) element.name = `${prefix}${sessionNumber}`;
                        if (element.type === 'file') {
                            element.setAttribute('onchange', `previewImage(this, '${prefix}Preview${sessionNumber}')`);
                        }
                    }
                });
                
                // ラベルのfor属性も更新
                const labels = section.querySelectorAll('label[for]');
                labels.forEach(label => {
                    const forAttr = label.getAttribute('for');
                    if (forAttr.includes('sessionDate')) label.setAttribute('for', `sessionDate${sessionNumber}`);
                    else if (forAttr.includes('sessionMenu')) label.setAttribute('for', `sessionMenu${sessionNumber}`);
                    else if (forAttr.includes('sessionSolution')) label.setAttribute('for', `sessionSolution${sessionNumber}`);
                    else if (forAttr.includes('beforeImage')) label.setAttribute('for', `beforeImage${sessionNumber}`);
                    else if (forAttr.includes('afterImage')) label.setAttribute('for', `afterImage${sessionNumber}`);
                    else if (forAttr.includes('sessionNotes')) label.setAttribute('for', `sessionNotes${sessionNumber}`);
                });
                
                // 削除ボタンの更新
                const removeBtn = section.querySelector('.remove-session-btn');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeImageSection(${sessionNumber})`);
                }
            });
            
            imageSessionCount = sections.length;
        }
        
        document.getElementById('saveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // フォームデータの収集
            const formData = new FormData(this);
            const data = {};
            
            // テキストデータの収集（画像関連以外）
            for (let [key, value] of formData.entries()) {
                if (!key.includes('beforeImage') && !key.includes('afterImage') && 
                    !key.includes('sessionDate') && !key.includes('sessionMenu') && 
                    !key.includes('sessionSolution') && !key.includes('sessionNotes')) {
                    data[key] = value;
                }
            }
            
            // チェックボックスの値を明示的に設定
            data.normalCase = document.getElementById('normalCase').checked;
            data.adverseReaction = document.getElementById('adverseReaction').checked;
            data.complaint = document.getElementById('complaint').checked;
            
            // 画像データの処理
            data.images = [];
            let newImageCount = 0;
            
            for (let i = 1; i <= imageSessionCount; i++) {
                const sessionDateInput = document.getElementById(`sessionDate${i}`);
                const sessionMenuSelect = document.getElementById(`sessionMenu${i}`);
                const sessionSolutionSelect = document.getElementById(`sessionSolution${i}`);
                const sessionNotesInput = document.getElementById(`sessionNotes${i}`);
                
                // 4段構成の画像データを収集
                const frontBeforeInput = document.getElementById(`frontBeforeImage${i}`);
                const frontAfterInput = document.getElementById(`frontAfterImage${i}`);
                const rightBeforeInput = document.getElementById(`rightBeforeImage${i}`);
                const rightAfterInput = document.getElementById(`rightAfterImage${i}`);
                const leftBeforeInput = document.getElementById(`leftBeforeImage${i}`);
                const leftAfterInput = document.getElementById(`leftAfterImage${i}`);
                const otherBeforeInput = document.getElementById(`otherBeforeImage${i}`);
                const otherAfterInput = document.getElementById(`otherAfterImage${i}`);
                
                // セッション情報と画像データを収集
                const sessionDate = sessionDateInput ? sessionDateInput.value : null;
                const sessionMenu = sessionMenuSelect ? sessionMenuSelect.value : null;
                const sessionSolution = sessionSolutionSelect ? sessionSolutionSelect.value : null;
                const sessionNotes = sessionNotesInput ? sessionNotesInput.value : null;
                
                // 画像ファイルのチェック
                const frontBeforeFile = frontBeforeInput ? frontBeforeInput.files[0] : null;
                const frontAfterFile = frontAfterInput ? frontAfterInput.files[0] : null;
                const rightBeforeFile = rightBeforeInput ? rightBeforeInput.files[0] : null;
                const rightAfterFile = rightAfterInput ? rightAfterInput.files[0] : null;
                const leftBeforeFile = leftBeforeInput ? leftBeforeInput.files[0] : null;
                const leftAfterFile = leftAfterInput ? leftAfterInput.files[0] : null;
                const otherBeforeFile = otherBeforeInput ? otherBeforeInput.files[0] : null;
                const otherAfterFile = otherAfterInput ? otherAfterInput.files[0] : null;
                
                // 既存データの場合はスキップ（読み取り専用）
                const section = document.getElementById(`imageSection${i}`);
                const isReadonly = section && section.querySelector('h3').textContent.includes('(既存データ)');
                
                // 何かのデータが入力されている場合のみ保存
                if (!isReadonly && (frontBeforeFile || frontAfterFile || rightBeforeFile || rightAfterFile || 
                    leftBeforeFile || leftAfterFile || otherBeforeFile || otherAfterFile ||
                    sessionDate || sessionMenu || sessionSolution || sessionNotes)) {
                    
                    newImageCount++;
                    data.images.push({
                        session: i,
                        date: sessionDate || new Date().toISOString().split('T')[0],
                        menu: sessionMenu,
                        solution: sessionSolution,
                        notes: sessionNotes,
                        // 4段構成の画像情報
                        frontBefore: frontBeforeFile ? frontBeforeFile.name : null,
                        frontAfter: frontAfterFile ? frontAfterFile.name : null,
                        rightBefore: rightBeforeFile ? rightBeforeFile.name : null,
                        rightAfter: rightAfterFile ? rightAfterFile.name : null,
                        leftBefore: leftBeforeFile ? leftBeforeFile.name : null,
                        leftAfter: leftAfterFile ? leftAfterFile.name : null,
                        otherBefore: otherBeforeFile ? otherBeforeFile.name : null,
                        otherAfter: otherAfterFile ? otherAfterFile.name : null,
                        // 互換性のために旧フォーマットも保持
                        before: frontBeforeFile ? frontBeforeFile.name : null,
                        after: frontAfterFile ? frontAfterFile.name : null
                    });
                }
            }
            
            // 新しい画像がない場合は警告
            if (newImageCount === 0) {
                alert('新しい施術画像をアップロードしてください。');
                return;
            }
            
            // 基本的な施術情報を設定
            data.sessionCount = newImageCount;
            data.frequency = newImageCount === 1 ? '初回' : '継続';
            data.period = `${newImageCount}回`;
            
            // システム情報
            data.id = 'save_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            data.timestamp = new Date().toISOString();
            data.type = 'saved'; // 保存された症例であることを示すフラグ
            
            // LocalStorageに保存
            const cases = JSON.parse(localStorage.getItem('floraskinCases') || '[]');
            cases.push(data);
            localStorage.setItem('floraskinCases', JSON.stringify(cases));
            
            alert(`症例を保存しました！（新規画像: ${newImageCount}回分）\n\n後で詳細な報告を追加する場合は、症例一覧から編集してください。`);
            
            // フォームをリセット
            this.reset();
            clearCustomerCheck();
            document.getElementById('ageGroup').value = '';
            
            // 画像セクションを初期状態にリセット
            const imageSections = document.getElementById('imageSections');
            imageSections.innerHTML = '';
            imageSessionCount = 0;
            addImageSectionWithData(1);
            
            // プレビュー画像をクリア
            const previews = document.querySelectorAll('.preview-image');
            previews.forEach(preview => {
                preview.style.display = 'none';
                preview.src = '';
            });
        });
        
        // 画像プレビューと編集機能
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // 編集ボタンを追加（まだ存在しない場合）
                    addEditButton(preview, input, previewId);
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // 画像編集機能（form.htmlと同じ機能をsave.html用に調整）
        let currentEditingInput = null;
        let currentPreviewId = null;
        let originalImageData = null;
        let editHistory = [];
        let isDrawing = false;
        let startX, startY;
        let editorCanvas, editorCtx;
        
        function addEditButton(preview, input, previewId) {
            const existingBtn = preview.parentNode.querySelector('.edit-image-btn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'edit-image-btn';
            editBtn.textContent = '編集';
            editBtn.style.cssText = `
                margin-top: 10px;
                padding: 5px 15px;
                background-color: #4caf50;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
            `;
            
            editBtn.onclick = function() {
                openImageEditor(input, previewId);
            };
            
            preview.parentNode.insertBefore(editBtn, preview.nextSibling);
        }
        
        function openImageEditor(input, previewId) {
            if (!input.files || !input.files[0]) return;
            
            currentEditingInput = input;
            currentPreviewId = previewId;
            editHistory = [];
            
            const modal = document.getElementById('imageEditorModal');
            editorCanvas = document.getElementById('imageEditorCanvas');
            editorCtx = editorCanvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                editorCanvas.width = img.width;
                editorCanvas.height = img.height;
                editorCtx.drawImage(img, 0, 0);
                
                originalImageData = editorCtx.getImageData(0, 0, img.width, img.height);
                setupCanvasEvents();
                
                const opacitySlider = document.getElementById('maskOpacity');
                const opacityValue = document.getElementById('maskOpacityValue');
                opacitySlider.oninput = function() {
                    opacityValue.textContent = this.value;
                    // 既存のマスクを再描画して透明度の変更を反映
                    redrawCanvas();
                };
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            };
            
            const preview = document.getElementById(previewId);
            img.src = preview.src;
        }
        
        function setupCanvasEvents() {
            editorCanvas.onmousedown = function(e) {
                isDrawing = true;
                const rect = editorCanvas.getBoundingClientRect();
                const scaleX = editorCanvas.width / rect.width;
                const scaleY = editorCanvas.height / rect.height;
                
                startX = (e.clientX - rect.left) * scaleX;
                startY = (e.clientY - rect.top) * scaleY;
            };
            
            editorCanvas.onmousemove = function(e) {
                if (!isDrawing) return;
                
                const rect = editorCanvas.getBoundingClientRect();
                const scaleX = editorCanvas.width / rect.width;
                const scaleY = editorCanvas.height / rect.height;
                
                const currentX = (e.clientX - rect.left) * scaleX;
                const currentY = (e.clientY - rect.top) * scaleY;
                
                // 現在の画像を再描画
                redrawCanvas();
                
                // プレビュー用の黒い長方形を表示
                const opacity = parseInt(document.getElementById('maskOpacity').value) / 100;
                editorCtx.save();
                editorCtx.fillStyle = `rgba(0, 0, 0, ${opacity * 0.7})`; // プレビュー時は少し薄く
                editorCtx.fillRect(
                    Math.min(startX, currentX),
                    Math.min(startY, currentY),
                    Math.abs(currentX - startX),
                    Math.abs(currentY - startY)
                );
                
                // 選択範囲の境界線も表示
                editorCtx.strokeStyle = '#4caf50';
                editorCtx.lineWidth = 2;
                editorCtx.setLineDash([5, 5]);
                editorCtx.strokeRect(
                    Math.min(startX, currentX),
                    Math.min(startY, currentY),
                    Math.abs(currentX - startX),
                    Math.abs(currentY - startY)
                );
                editorCtx.setLineDash([]);
                editorCtx.restore();
            };
            
            editorCanvas.onmouseup = function(e) {
                if (!isDrawing) return;
                isDrawing = false;
                
                const rect = editorCanvas.getBoundingClientRect();
                const scaleX = editorCanvas.width / rect.width;
                const scaleY = editorCanvas.height / rect.height;
                
                const endX = (e.clientX - rect.left) * scaleX;
                const endY = (e.clientY - rect.top) * scaleY;
                
                if (Math.abs(endX - startX) > 10 && Math.abs(endY - startY) > 10) {
                    // マスクの座標情報を履歴に保存
                    const maskData = {
                        x: Math.min(startX, endX),
                        y: Math.min(startY, endY),
                        width: Math.abs(endX - startX),
                        height: Math.abs(endY - startY)
                    };
                    editHistory.push(maskData);
                    
                    // 黒いマスク適用
                    applyBlackMask(maskData.x, maskData.y, maskData.width, maskData.height);
                }
                
                redrawCanvas();
            };
        }
        
        function redrawCanvas() {
            // 元画像を描画
            editorCtx.putImageData(originalImageData, 0, 0);
            
            // 履歴にある全てのマスクを現在の透明度で再描画
            const currentOpacity = parseInt(document.getElementById('maskOpacity').value) / 100;
            if (editHistory.length > 0) {
                editHistory.forEach(mask => {
                    editorCtx.save();
                    editorCtx.fillStyle = `rgba(0, 0, 0, ${currentOpacity})`;
                    editorCtx.fillRect(mask.x, mask.y, mask.width, mask.height);
                    editorCtx.restore();
                });
            }
        }
        
        function applyBlackMask(x, y, width, height) {
            const opacity = parseInt(document.getElementById('maskOpacity').value) / 100;
            
            // 現在の描画状態を保存
            editorCtx.save();
            
            // 黒い長方形を描画
            editorCtx.fillStyle = `rgba(0, 0, 0, ${opacity})`;
            editorCtx.fillRect(x, y, width, height);
            
            // 描画状態を復元
            editorCtx.restore();
        }
        
        function undoLastMask() {
            if (editHistory.length > 0) {
                editHistory.pop();
                redrawCanvas();
            }
        }
        
        function clearAllMasks() {
            editHistory = [];
            redrawCanvas();
        }
        
        function applyImageEdits() {
            editorCanvas.toBlob(function(blob) {
                const editedFile = new File([blob], currentEditingInput.files[0].name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                
                const dt = new DataTransfer();
                dt.items.add(editedFile);
                currentEditingInput.files = dt.files;
                
                const preview = document.getElementById(currentPreviewId);
                preview.src = editorCanvas.toDataURL('image/jpeg', 0.9);
                
                closeImageEditor();
            }, 'image/jpeg', 0.9);
        }
        
        function closeImageEditor() {
            const modal = document.getElementById('imageEditorModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            currentEditingInput = null;
            currentPreviewId = null;
            originalImageData = null;
            editHistory = [];
        }
    </script>
    
    <!-- 画像編集モーダル -->
    <div class="image-editor-modal" id="imageEditorModal">
        <div class="image-editor-content">
            <div class="editor-header">
                <div class="editor-title">画像編集 - 目隠し処理</div>
                <button class="editor-close" onclick="closeImageEditor()">&times;</button>
            </div>
            
            <div class="editor-canvas-container">
                <canvas id="imageEditorCanvas" class="editor-canvas"></canvas>
            </div>
            
            <div class="editor-controls">
                <div class="opacity-container">
                    <label for="maskOpacity">透明度:</label>
                    <input type="range" id="maskOpacity" class="opacity-slider" min="70" max="100" value="100">
                    <span id="maskOpacityValue">100</span>%
                </div>
                
                <button class="editor-button secondary" onclick="undoLastMask()">元に戻す</button>
                <button class="editor-button secondary" onclick="clearAllMasks()">全てクリア</button>
                <button class="editor-button primary" onclick="applyImageEdits()">適用</button>
                <button class="editor-button secondary" onclick="closeImageEditor()">キャンセル</button>
                
                <div class="selection-info">
                    マウスでドラッグして目隠しをかけたい範囲を選択してください
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ページ読み込み時の認証チェック
        window.onload = function() {
            checkAuthentication();
        };
        
        function checkAuthentication() {
            const loginInfo = localStorage.getItem('floraskinLogin');
            if (!loginInfo) {
                window.location.href = 'login.html';
                return;
            }
            
            const login = JSON.parse(loginInfo);
            document.getElementById('userInfo').textContent = `${login.store} (${login.userId})`;
            
            // 店舗を自動選択
            const storeSelect = document.getElementById('store');
            if (storeSelect) {
                storeSelect.value = login.store;
                storeSelect.disabled = login.role !== 'admin'; // 管理者以外は変更不可
            }
        }
        
        function logout() {
            if (confirm('ログアウトしますか？')) {
                localStorage.removeItem('floraskinLogin');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
