<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>florasKIN 症例報告フォーム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .form-header {
            background-color: #673ab7;
            color: white;
            padding: 30px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .form-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .form-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .form-body {
            background-color: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #673ab7;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .required {
            color: #d32f2f;
            margin-left: 4px;
        }
        
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #673ab7;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: block;
            padding: 10px 15px;
            background-color: #f5f5f5;
            border: 2px dashed #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-label:hover {
            background-color: #eeeeee;
            border-color: #673ab7;
        }
        
        .image-group {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
            position: relative;
        }
        
        /* 画像編集モーダル */
        .image-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow: auto;
        }
        
        .image-editor-content {
            background-color: white;
            margin: 20px auto;
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            position: relative;
            padding: 20px;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .editor-title {
            font-size: 18px;
            font-weight: bold;
            color: #673ab7;
        }
        
        .editor-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .editor-close:hover {
            color: #673ab7;
        }
        
        .editor-canvas-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            max-height: 60vh;
            overflow: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .editor-canvas {
            display: block;
            max-width: 100%;
            height: auto;
            cursor: crosshair;
        }
        
        .editor-controls {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .editor-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .editor-button.primary {
            background-color: #673ab7;
            color: white;
        }
        
        .editor-button.primary:hover {
            background-color: #5e35b1;
        }
        
        .editor-button.secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .editor-button.secondary:hover {
            background-color: #e0e0e0;
        }
        
        .opacity-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .opacity-slider {
            width: 100px;
        }
        
        .selection-info {
            color: #666;
            font-size: 12px;
            margin-left: 15px;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .image-editor-content {
                margin: 10px;
                max-width: calc(100% - 20px);
                padding: 15px;
            }
            
            .editor-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .editor-button {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .opacity-container {
                justify-content: center;
            }
        }
        
        .remove-session-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-session-btn:hover {
            background-color: #d32f2f;
        }
        
        .add-session-btn {
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .add-session-btn:hover {
            background-color: #45a049;
        }
        
        .image-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .submit-button {
            background-color: #673ab7;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin: 30px auto 0;
            transition: background-color 0.3s;
        }
        
        .submit-button:hover {
            background-color: #5e35b1;
        }
        
        .info-box {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .preview-image {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border-radius: 5px;
        }
        
        .image-angle-section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #fafbfc;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .customer-check {
            margin-top: 10px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        
        .customer-check.warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        .customer-check.error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }
        
        .customer-check.success {
            background-color: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }
        
        .customer-check strong {
            display: block;
            margin-bottom: 8px;
        }
        
        .customer-check-actions {
            margin-top: 10px;
        }
        
        .customer-check-actions a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .customer-check-actions a:hover {
            text-decoration: underline;
        }
        
        .check-button {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .check-button:hover {
            background-color: #138496;
        }
        
        .check-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
            margin-bottom: 0;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .checkbox-text {
            color: #555;
            font-size: 16px;
        }
        
        .checkbox-label:hover .checkbox-text {
            color: #673ab7;
        }
        
        .session-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        /* タブレット */
        @media (max-width: 1024px) {
            .container {
                padding: 15px;
            }
            
            .form-header {
                padding: 25px;
            }
            
            .form-body {
                padding: 25px;
            }
            
            .session-info {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        /* スマホ (横向き) */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .form-header {
                padding: 22px;
            }
            
            .form-body {
                padding: 22px;
            }
            
            .image-row {
                grid-template-columns: 1fr;
            }
            
            .session-info {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* スマホ (縦向き) */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .form-header {
                padding: 20px;
            }
            
            .form-header h1 {
                font-size: 20px;
            }
            
            .form-header p {
                font-size: 13px;
            }
            
            .form-body {
                padding: 20px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            input[type="text"],
            input[type="number"],
            input[type="date"],
            select,
            textarea {
                font-size: 16px;
                padding: 12px 15px;
            }
            
            .submit-button {
                padding: 12px 30px;
                font-size: 15px;
            }
        }
        
        .header {
            position: fixed;
            top: 0;
            right: 0;
            background-color: rgba(255,255,255,0.9);
            padding: 15px 20px;
            border-radius: 0 0 0 10px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            font-size: 14px;
            color: #666;
        }
        
        .logout-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        
        .logout-btn:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info" id="userInfo"></div>
        <button class="logout-btn" onclick="logout()">ログアウト</button>
    </div>
    
    <div class="container">
        <form id="caseForm">
            <div class="form-header">
                <h1>florasKIN 症例報告フォーム</h1>
                <p>お客様の症例情報を共有いただき、ありがとうございます。</p>
                <p>【入力時間の目安】約10〜15分</p>
            </div>
            
            <div class="form-body">
                <div class="form-section">
                    <h2 class="section-title">基本情報</h2>
                    
                    <div class="form-group">
                        <label>症例区分</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="normalCase" name="normalCase" value="true" checked>
                                <span class="checkbox-text">通常症例</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="adverseReaction" name="adverseReaction" value="true">
                                <span class="checkbox-text">好転反応</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="complaint" name="complaint" value="true">
                                <span class="checkbox-text">クレーム</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerNumber">顧客番号<span class="required">*</span></label>
                        <input type="text" id="customerNumber" name="customerNumber" required placeholder="例：FK-001234" onblur="checkDuplicateCustomer()" oninput="clearCustomerCheck()">
                        <button type="button" class="check-button" onclick="checkDuplicateCustomer()" id="checkButton">重複チェック</button>
                        
                        <div id="customerCheckResult" class="customer-check">
                            <!-- チェック結果がここに表示されます -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="store">店舗<span class="required">*</span></label>
                        <select id="store" name="store" required>
                            <option value="">選択してください</option>
                            <option value="銀座Miel店">florasKIN 銀座Miel店</option>
                            <option value="銀座Blanc店">florasKIN 銀座Blanc店</option>
                            <option value="上野店">florasKIN 上野店</option>
                            <option value="恵比寿店">florasKIN 恵比寿店</option>
                            <option value="心斎橋店">florasKIN 心斎橋店</option>
                            <option value="難波店">florasKIN 難波店</option>
                            <option value="梅田店">florasKIN 梅田店</option>
                            <option value="三宮店">florasKIN 三宮店</option>
                            <option value="横浜店">florasKIN 横浜店</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="staffName">担当者名<span class="required">*</span></label>
                        <input type="text" id="staffName" name="staffName" required placeholder="例：山田 花子">
                    </div>
                    
                    <div class="form-group">
                        <label for="birthDate">お客様の生年月日<span class="required">*</span></label>
                        <input type="date" id="birthDate" name="birthDate" required onchange="calculateAgeGroup()">
                    </div>
                    
                    <div class="form-group">
                        <label for="ageGroup">年齢層（自動計算）</label>
                        <input type="text" id="ageGroup" name="ageGroup" readonly style="background-color: #f5f5f5;" placeholder="生年月日を入力すると自動計算されます">
                    </div>
                    
                    <div class="form-group">
                        <label for="concern">主な悩み<span class="required">*</span></label>
                        <input type="text" id="concern" name="concern" required placeholder="例：シミ、たるみ、乾燥など">
                    </div>
                    
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">施術情報</h2>
                    
                    <div class="form-group">
                        <label for="sessionCount">施術の回数<span class="required">*</span></label>
                        <input type="number" id="sessionCount" name="sessionCount" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="frequency">頻度<span class="required">*</span></label>
                        <input type="text" id="frequency" name="frequency" required placeholder="例：週1回、2週間に1回など">
                    </div>
                    
                    <div class="form-group">
                        <label for="period">期間<span class="required">*</span></label>
                        <input type="text" id="period" name="period" required placeholder="例：3ヶ月、6ヶ月など">
                    </div>
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">詳細情報</h2>
                    
                    <div class="form-group">
                        <label for="treatmentNotes">施術において注意や意識したこと<span class="required">*</span></label>
                        <textarea id="treatmentNotes" name="treatmentNotes" required placeholder="施術時に特に注意した点や意識したことを詳しく記入してください"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="lifestyle">お客様の生活習慣・自宅ケア<span class="required">*</span></label>
                        <textarea id="lifestyle" name="lifestyle" required placeholder="お客様の生活習慣や自宅でのケア方法について記入してください"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="progress">結果が出るまでの経過<span class="required">*</span></label>
                        <textarea id="progress" name="progress" required placeholder="どのような経過を辿って結果が出たか詳しく記入してください"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="innovations">総括して工夫した点<span class="required">*</span></label>
                        <textarea id="innovations" name="innovations" required placeholder="施術全体を通して工夫した点を記入してください"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="futureCare">今後のケア提案<span class="required">*</span></label>
                        <textarea id="futureCare" name="futureCare" required placeholder="お客様への今後のケア提案を記入してください"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalNotes">備考</label>
                        <textarea id="additionalNotes" name="additionalNotes" placeholder="その他、特記事項があれば記入してください（任意）"></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">利用許可</h2>
                    
                    <div class="form-group">
                        <label for="secondaryUse">二次利用可否<span class="required">*</span></label>
                        <select id="secondaryUse" name="secondaryUse" required onchange="toggleSecondaryUseNote()">
                            <option value="">選択してください</option>
                            <option value="全顔OK">全顔OK（HP掲載・広告利用等での使用を許可）</option>
                            <option value="目元モザイクあればOK">目元モザイクあればOK（目元処理後の使用を許可）</option>
                            <option value="店舗内のみOK">店舗内のみOK（店舗でのご案内・相談時のみ使用可能）</option>
                            <option value="掲載NG">掲載NG（社内での症例共有・学習目的のみ）</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="secondaryUseNoteGroup" style="display: none;">
                        <label for="secondaryUseNote">二次利用に関する特記事項</label>
                        <textarea id="secondaryUseNote" name="secondaryUseNote" placeholder="条件や制限事項がある場合は詳細を記入してください"></textarea>
                    </div>
                    
                    <div class="info-box">
                        <strong>二次利用について</strong><br>
                        ・「全顔OK」：ホームページ掲載、広告、研修資料等での使用が可能<br>
                        ・「目元モザイクあればOK」：目元にモザイク処理を施した上での使用が可能<br>
                        ・「店舗内のみOK」：店舗でのカウンセリング・ご案内時のみ使用可能<br>
                        ・「掲載NG」：社内での症例共有・学習目的のみでの使用
                    </div>
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">Before / After 画像</h2>
                    
                    <div class="info-box">
                        【撮影のポイント】<br>
                        ・同じ角度・距離から撮影<br>
                        ・明るさを統一（自然光推奨）<br>
                        ・背景をシンプルに<br>
                        ・お客様の許可を必ず取得
                    </div>
                    
                    <div id="imageSections">
                        <div id="imageSection1" class="image-group">
                            <h3>1回目</h3>
                            <div class="session-info">
                                <div class="form-group">
                                    <label for="sessionDate1">施術日</label>
                                    <input type="date" id="sessionDate1" name="sessionDate1">
                                </div>
                                <div class="form-group">
                                    <label for="sessionMenu1">選択したメニュー</label>
                                    <select id="sessionMenu1" name="sessionMenu1">
                                        <option value="">選択してください</option>
                                        <option value="フローラ毛穴洗浄">フローラ毛穴洗浄</option>
                                        <option value="フローラ肌質改善">フローラ肌質改善</option>
                                        <option value="フローラワックス">フローラワックス</option>
                                        <option value="その他">その他</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="sessionSolution1">使用溶剤</label>
                                    <select id="sessionSolution1" name="sessionSolution1">
                                        <option value="">選択してください</option>
                                        <option value="メラショット">メラショット</option>
                                        <option value="アドバンスト">アドバンスト</option>
                                        <option value="モーメント">モーメント</option>
                                        <option value="その他">その他</option>
                                    </select>
                                </div>
                            </div>
                            <!-- 正面画像 -->
                            <div class="image-angle-section">
                                <h4 style="font-size: 16px; font-weight: bold; color: #673ab7; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">正面画像</h4>
                                <div class="image-row">
                                    <div class="form-group">
                                        <label for="frontBefore1">Before画像（正面）</label>
                                        <div class="file-upload">
                                            <input type="file" id="frontBefore1" name="frontBefore1" accept="image/*" onchange="previewImage(this, 'frontBefore1Preview')">
                                            <label for="frontBefore1" class="file-upload-label">
                                                正面Before画像を選択
                                            </label>
                                        </div>
                                        <img id="frontBefore1Preview" class="preview-image" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="frontAfter1">After画像（正面）</label>
                                        <div class="file-upload">
                                            <input type="file" id="frontAfter1" name="frontAfter1" accept="image/*" onchange="previewImage(this, 'frontAfter1Preview')">
                                            <label for="frontAfter1" class="file-upload-label">
                                                正面After画像を選択
                                            </label>
                                        </div>
                                        <img id="frontAfter1Preview" class="preview-image" style="display: none;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右側画像 -->
                            <div class="image-angle-section">
                                <h4 style="font-size: 16px; font-weight: bold; color: #673ab7; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">右側画像（任意）</h4>
                                <div class="image-row">
                                    <div class="form-group">
                                        <label for="rightBefore1">Before画像（右側）</label>
                                        <div class="file-upload">
                                            <input type="file" id="rightBefore1" name="rightBefore1" accept="image/*" onchange="previewImage(this, 'rightBefore1Preview')">
                                            <label for="rightBefore1" class="file-upload-label">
                                                右側Before画像を選択
                                            </label>
                                        </div>
                                        <img id="rightBefore1Preview" class="preview-image" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="rightAfter1">After画像（右側）</label>
                                        <div class="file-upload">
                                            <input type="file" id="rightAfter1" name="rightAfter1" accept="image/*" onchange="previewImage(this, 'rightAfter1Preview')">
                                            <label for="rightAfter1" class="file-upload-label">
                                                右側After画像を選択
                                            </label>
                                        </div>
                                        <img id="rightAfter1Preview" class="preview-image" style="display: none;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 左側画像 -->
                            <div class="image-angle-section">
                                <h4 style="font-size: 16px; font-weight: bold; color: #673ab7; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">左側画像（任意）</h4>
                                <div class="image-row">
                                    <div class="form-group">
                                        <label for="leftBefore1">Before画像（左側）</label>
                                        <div class="file-upload">
                                            <input type="file" id="leftBefore1" name="leftBefore1" accept="image/*" onchange="previewImage(this, 'leftBefore1Preview')">
                                            <label for="leftBefore1" class="file-upload-label">
                                                左側Before画像を選択
                                            </label>
                                        </div>
                                        <img id="leftBefore1Preview" class="preview-image" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="leftAfter1">After画像（左側）</label>
                                        <div class="file-upload">
                                            <input type="file" id="leftAfter1" name="leftAfter1" accept="image/*" onchange="previewImage(this, 'leftAfter1Preview')">
                                            <label for="leftAfter1" class="file-upload-label">
                                                左側After画像を選択
                                            </label>
                                        </div>
                                        <img id="leftAfter1Preview" class="preview-image" style="display: none;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- その他画像 -->
                            <div class="image-angle-section">
                                <h4 style="font-size: 16px; font-weight: bold; color: #673ab7; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">その他画像（任意）</h4>
                                <div class="image-row">
                                    <div class="form-group">
                                        <label for="otherBefore1">Before画像（その他）</label>
                                        <div class="file-upload">
                                            <input type="file" id="otherBefore1" name="otherBefore1" accept="image/*" onchange="previewImage(this, 'otherBefore1Preview')">
                                            <label for="otherBefore1" class="file-upload-label">
                                                その他Before画像を選択
                                            </label>
                                        </div>
                                        <img id="otherBefore1Preview" class="preview-image" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="otherAfter1">After画像（その他）</label>
                                        <div class="file-upload">
                                            <input type="file" id="otherAfter1" name="otherAfter1" accept="image/*" onchange="previewImage(this, 'otherAfter1Preview')">
                                            <label for="otherAfter1" class="file-upload-label">
                                                その他After画像を選択
                                            </label>
                                        </div>
                                        <img id="otherAfter1Preview" class="preview-image" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="sessionNotes1">備考</label>
                            <textarea id="sessionNotes1" name="sessionNotes1" rows="3" 
                                      placeholder="この回の施術について特記事項があれば記入してください..."
                                      style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 60px; transition: border-color 0.3s;"></textarea>
                        </div>
                    </div>
                    
                    <button type="button" class="add-session-btn" onclick="addImageSection()">
                        施術回を追加
                    </button>
                </div>
                
                <button type="submit" class="submit-button">送信</button>
            </div>
        </form>
    </div>
    
    <script>
        let imageSessionCount = 1;
        
        
        function calculateAgeGroup() {
            const birthDateInput = document.getElementById('birthDate');
            const ageGroupInput = document.getElementById('ageGroup');
            
            if (!birthDateInput.value) {
                ageGroupInput.value = '';
                return;
            }
            
            const birthDate = new Date(birthDateInput.value);
            const today = new Date();
            
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            let ageGroup = '';
            if (age < 20) {
                ageGroup = '10代';
            } else if (age < 30) {
                ageGroup = '20代';
            } else if (age < 40) {
                ageGroup = '30代';
            } else if (age < 50) {
                ageGroup = '40代';
            } else if (age < 60) {
                ageGroup = '50代';
            } else {
                ageGroup = '60代以上';
            }
            
            ageGroupInput.value = ageGroup;
        }
        
        function toggleSecondaryUseNote() {
            const secondaryUseSelect = document.getElementById('secondaryUse');
            const secondaryUseNoteGroup = document.getElementById('secondaryUseNoteGroup');
            
            if (secondaryUseSelect.value === '目元モザイクあればOK' || secondaryUseSelect.value === '店舗内のみOK') {
                secondaryUseNoteGroup.style.display = 'block';
            } else {
                secondaryUseNoteGroup.style.display = 'none';
                document.getElementById('secondaryUseNote').value = '';
            }
        }
        
        function addImageSection() {
            imageSessionCount++;
            const imageSections = document.getElementById('imageSections');
            
            const newSection = document.createElement('div');
            newSection.id = `imageSection${imageSessionCount}`;
            newSection.className = 'image-group';
            
            newSection.innerHTML = `
                ${imageSessionCount > 1 ? '<button type="button" class="remove-session-btn" onclick="removeImageSection(' + imageSessionCount + ')">&times;</button>' : ''}
                <h3>${imageSessionCount}回目</h3>
                <div class="session-info">
                    <div class="form-group">
                        <label for="sessionDate${imageSessionCount}">施術日</label>
                        <input type="date" id="sessionDate${imageSessionCount}" name="sessionDate${imageSessionCount}">
                    </div>
                    <div class="form-group">
                        <label for="sessionMenu${imageSessionCount}">選択したメニュー</label>
                        <select id="sessionMenu${imageSessionCount}" name="sessionMenu${imageSessionCount}">
                            <option value="">選択してください</option>
                            <option value="フローラ毛穴洗浄">フローラ毛穴洗浄</option>
                            <option value="フローラ肌質改善">フローラ肌質改善</option>
                            <option value="フローラワックス">フローラワックス</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sessionSolution${imageSessionCount}">使用溶剤</label>
                        <select id="sessionSolution${imageSessionCount}" name="sessionSolution${imageSessionCount}">
                            <option value="">選択してください</option>
                            <option value="メラショット">メラショット</option>
                            <option value="アドバンスト">アドバンスト</option>
                            <option value="モーメント">モーメント</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                </div>
                <!-- 正面画像 -->
                <div class="image-angle-section">
                    <h4 style="font-size: 16px; font-weight: bold; color: #673ab7; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">正面画像</h4>
                    <div class="image-row">
                        <div class="form-group">
                            <label for="frontBefore${imageSessionCount}">Before画像（正面）</label>
                            <div class="file-upload">
                                <input type="file" id="frontBefore${imageSessionCount}" name="frontBefore${imageSessionCount}" accept="image/*" onchange="previewImage(this, 'frontBefore${imageSessionCount}Preview')">
                                <label for="frontBefore${imageSessionCount}" class="file-upload-label">
                                    正面Before画像を選択
                                </label>
                            </div>
                            <img id="frontBefore${imageSessionCount}Preview" class="preview-image" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="frontAfter${imageSessionCount}">After画像（正面）</label>
                            <div class="file-upload">
                                <input type="file" id="frontAfter${imageSessionCount}" name="frontAfter${imageSessionCount}" accept="image/*" onchange="previewImage(this, 'frontAfter${imageSessionCount}Preview')">
                                <label for="frontAfter${imageSessionCount}" class="file-upload-label">
                                    正面After画像を選択
                                </label>
                            </div>
                            <img id="frontAfter${imageSessionCount}Preview" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <!-- 右側画像 -->
                <div class="image-angle-section">
                    <h4 style="font-size: 16px; font-weight: bold; color: #673ab7; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">右側画像（任意）</h4>
                    <div class="image-row">
                        <div class="form-group">
                            <label for="rightBefore${imageSessionCount}">Before画像（右側）</label>
                            <div class="file-upload">
                                <input type="file" id="rightBefore${imageSessionCount}" name="rightBefore${imageSessionCount}" accept="image/*" onchange="previewImage(this, 'rightBefore${imageSessionCount}Preview')">
                                <label for="rightBefore${imageSessionCount}" class="file-upload-label">
                                    右側Before画像を選択
                                </label>
                            </div>
                            <img id="rightBefore${imageSessionCount}Preview" class="preview-image" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="rightAfter${imageSessionCount}">After画像（右側）</label>
                            <div class="file-upload">
                                <input type="file" id="rightAfter${imageSessionCount}" name="rightAfter${imageSessionCount}" accept="image/*" onchange="previewImage(this, 'rightAfter${imageSessionCount}Preview')">
                                <label for="rightAfter${imageSessionCount}" class="file-upload-label">
                                    右側After画像を選択
                                </label>
                            </div>
                            <img id="rightAfter${imageSessionCount}Preview" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <!-- 左側画像 -->
                <div class="image-angle-section">
                    <h4 style="font-size: 16px; font-weight: bold; color: #673ab7; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">左側画像（任意）</h4>
                    <div class="image-row">
                        <div class="form-group">
                            <label for="leftBefore${imageSessionCount}">Before画像（左側）</label>
                            <div class="file-upload">
                                <input type="file" id="leftBefore${imageSessionCount}" name="leftBefore${imageSessionCount}" accept="image/*" onchange="previewImage(this, 'leftBefore${imageSessionCount}Preview')">
                                <label for="leftBefore${imageSessionCount}" class="file-upload-label">
                                    左側Before画像を選択
                                </label>
                            </div>
                            <img id="leftBefore${imageSessionCount}Preview" class="preview-image" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="leftAfter${imageSessionCount}">After画像（左側）</label>
                            <div class="file-upload">
                                <input type="file" id="leftAfter${imageSessionCount}" name="leftAfter${imageSessionCount}" accept="image/*" onchange="previewImage(this, 'leftAfter${imageSessionCount}Preview')">
                                <label for="leftAfter${imageSessionCount}" class="file-upload-label">
                                    左側After画像を選択
                                </label>
                            </div>
                            <img id="leftAfter${imageSessionCount}Preview" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <!-- その他画像 -->
                <div class="image-angle-section">
                    <h4 style="font-size: 16px; font-weight: bold; color: #673ab7; margin-bottom: 15px; text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">その他画像（任意）</h4>
                    <div class="image-row">
                        <div class="form-group">
                            <label for="otherBefore${imageSessionCount}">Before画像（その他）</label>
                            <div class="file-upload">
                                <input type="file" id="otherBefore${imageSessionCount}" name="otherBefore${imageSessionCount}" accept="image/*" onchange="previewImage(this, 'otherBefore${imageSessionCount}Preview')">
                                <label for="otherBefore${imageSessionCount}" class="file-upload-label">
                                    その他Before画像を選択
                                </label>
                            </div>
                            <img id="otherBefore${imageSessionCount}Preview" class="preview-image" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="otherAfter${imageSessionCount}">After画像（その他）</label>
                            <div class="file-upload">
                                <input type="file" id="otherAfter${imageSessionCount}" name="otherAfter${imageSessionCount}" accept="image/*" onchange="previewImage(this, 'otherAfter${imageSessionCount}Preview')">
                                <label for="otherAfter${imageSessionCount}" class="file-upload-label">
                                    その他After画像を選択
                                </label>
                            </div>
                            <img id="otherAfter${imageSessionCount}Preview" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sessionNotes${imageSessionCount}">備考</label>
                    <textarea id="sessionNotes${imageSessionCount}" name="sessionNotes${imageSessionCount}" rows="3" 
                              placeholder="この回の施術について特記事項があれば記入してください..."
                              style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 60px; transition: border-color 0.3s;"></textarea>
                </div>
            `;
            
            imageSections.appendChild(newSection);
            updateSessionCount();
        }
        
        function removeImageSection(sessionId) {
            const section = document.getElementById(`imageSection${sessionId}`);
            if (section) {
                section.remove();
                renumberSections();
                updateSessionCount();
            }
        }
        
        function renumberSections() {
            const sections = document.querySelectorAll('.image-group');
            sections.forEach((section, index) => {
                const sessionNumber = index + 1;
                section.id = `imageSection${sessionNumber}`;
                
                const title = section.querySelector('h3');
                title.textContent = `${sessionNumber}回目`;
                
                // Update input IDs and names
                const sessionDateInput = section.querySelector('input[type="date"]');
                const sessionDateLabel = section.querySelector('label[for^="sessionDate"]');
                const sessionMenuSelect = section.querySelector('select[id^="sessionMenu"]');
                const sessionMenuLabel = section.querySelector('label[for^="sessionMenu"]');
                const sessionSolutionSelect = section.querySelector('select[id^="sessionSolution"]');
                const sessionSolutionLabel = section.querySelector('label[for^="sessionSolution"]');
                const beforeInput = section.querySelector('input[type="file"]:first-of-type');
                const afterInput = section.querySelector('input[type="file"]:last-of-type');
                const beforeLabel = section.querySelector('label[for^="before"]');
                const afterLabel = section.querySelector('label[for^="after"]');
                const beforePreview = section.querySelector('img[id$="Preview"]:first-of-type');
                const afterPreview = section.querySelector('img[id$="Preview"]:last-of-type');
                const sessionNotesInput = section.querySelector('textarea[id^="sessionNotes"]');
                const sessionNotesLabel = section.querySelector('label[for^="sessionNotes"]');
                const removeBtn = section.querySelector('.remove-session-btn');
                
                if (sessionDateInput) {
                    sessionDateInput.id = `sessionDate${sessionNumber}`;
                    sessionDateInput.name = `sessionDate${sessionNumber}`;
                }
                if (sessionDateLabel) {
                    sessionDateLabel.setAttribute('for', `sessionDate${sessionNumber}`);
                }
                if (sessionMenuSelect) {
                    sessionMenuSelect.id = `sessionMenu${sessionNumber}`;
                    sessionMenuSelect.name = `sessionMenu${sessionNumber}`;
                }
                if (sessionMenuLabel) {
                    sessionMenuLabel.setAttribute('for', `sessionMenu${sessionNumber}`);
                }
                if (sessionSolutionSelect) {
                    sessionSolutionSelect.id = `sessionSolution${sessionNumber}`;
                    sessionSolutionSelect.name = `sessionSolution${sessionNumber}`;
                }
                if (sessionSolutionLabel) {
                    sessionSolutionLabel.setAttribute('for', `sessionSolution${sessionNumber}`);
                }
                if (beforeInput) {
                    beforeInput.id = `before${sessionNumber}`;
                    beforeInput.name = `before${sessionNumber}`;
                    beforeInput.setAttribute('onchange', `previewImage(this, 'before${sessionNumber}Preview')`);
                }
                if (afterInput) {
                    afterInput.id = `after${sessionNumber}`;
                    afterInput.name = `after${sessionNumber}`;
                    afterInput.setAttribute('onchange', `previewImage(this, 'after${sessionNumber}Preview')`);
                }
                if (beforeLabel) {
                    beforeLabel.setAttribute('for', `before${sessionNumber}`);
                }
                if (afterLabel) {
                    afterLabel.setAttribute('for', `after${sessionNumber}`);
                }
                if (beforePreview) {
                    beforePreview.id = `before${sessionNumber}Preview`;
                }
                if (afterPreview) {
                    afterPreview.id = `after${sessionNumber}Preview`;
                }
                if (sessionNotesInput) {
                    sessionNotesInput.id = `sessionNotes${sessionNumber}`;
                    sessionNotesInput.name = `sessionNotes${sessionNumber}`;
                }
                if (sessionNotesLabel) {
                    sessionNotesLabel.setAttribute('for', `sessionNotes${sessionNumber}`);
                }
                if (removeBtn && sessionNumber > 1) {
                    removeBtn.setAttribute('onclick', `removeImageSection(${sessionNumber})`);
                } else if (removeBtn && sessionNumber === 1) {
                    removeBtn.remove();
                }
            });
            
            imageSessionCount = sections.length;
        }
        
        function updateSessionCount() {
            const sessionCountInput = document.getElementById('sessionCount');
            sessionCountInput.value = imageSessionCount;
        }
        
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // 編集ボタンを追加（まだ存在しない場合）
                    addEditButton(preview, input, previewId);
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // 画像編集機能
        let currentEditingInput = null;
        let currentPreviewId = null;
        let originalImageData = null;
        let editHistory = [];
        let isDrawing = false;
        let startX, startY;
        let editorCanvas, editorCtx;
        
        function addEditButton(preview, input, previewId) {
            // 既存の編集ボタンがあれば削除
            const existingBtn = preview.parentNode.querySelector('.edit-image-btn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            // 編集ボタンを作成
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'edit-image-btn';
            editBtn.textContent = '編集';
            editBtn.style.cssText = `
                margin-top: 10px;
                padding: 5px 15px;
                background-color: #673ab7;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
            `;
            
            editBtn.onclick = function() {
                openImageEditor(input, previewId);
            };
            
            preview.parentNode.insertBefore(editBtn, preview.nextSibling);
        }
        
        function openImageEditor(input, previewId) {
            if (!input.files || !input.files[0]) return;
            
            currentEditingInput = input;
            currentPreviewId = previewId;
            editHistory = [];
            
            const modal = document.getElementById('imageEditorModal');
            editorCanvas = document.getElementById('imageEditorCanvas');
            editorCtx = editorCanvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                // キャンバスサイズを画像に合わせる
                editorCanvas.width = img.width;
                editorCanvas.height = img.height;
                editorCtx.drawImage(img, 0, 0);
                
                // 元画像データを保存
                originalImageData = editorCtx.getImageData(0, 0, img.width, img.height);
                
                // キャンバスイベントリスナーを設定
                setupCanvasEvents();
                
                // 透明度スライダーのイベント
                const opacitySlider = document.getElementById('maskOpacity');
                const opacityValue = document.getElementById('maskOpacityValue');
                opacitySlider.oninput = function() {
                    opacityValue.textContent = this.value;
                    // 既存のマスクを再描画して透明度の変更を反映
                    redrawCanvas();
                };
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            };
            
            const preview = document.getElementById(previewId);
            img.src = preview.src;
        }
        
        function setupCanvasEvents() {
            editorCanvas.onmousedown = function(e) {
                isDrawing = true;
                const rect = editorCanvas.getBoundingClientRect();
                const scaleX = editorCanvas.width / rect.width;
                const scaleY = editorCanvas.height / rect.height;
                
                startX = (e.clientX - rect.left) * scaleX;
                startY = (e.clientY - rect.top) * scaleY;
            };
            
            editorCanvas.onmousemove = function(e) {
                if (!isDrawing) return;
                
                const rect = editorCanvas.getBoundingClientRect();
                const scaleX = editorCanvas.width / rect.width;
                const scaleY = editorCanvas.height / rect.height;
                
                const currentX = (e.clientX - rect.left) * scaleX;
                const currentY = (e.clientY - rect.top) * scaleY;
                
                // 現在の画像を再描画
                redrawCanvas();
                
                // プレビュー用の黒い長方形を表示
                const opacity = parseInt(document.getElementById('maskOpacity').value) / 100;
                editorCtx.save();
                editorCtx.fillStyle = `rgba(0, 0, 0, ${opacity * 0.7})`; // プレビュー時は少し薄く
                editorCtx.fillRect(
                    Math.min(startX, currentX),
                    Math.min(startY, currentY),
                    Math.abs(currentX - startX),
                    Math.abs(currentY - startY)
                );
                
                // 選択範囲の境界線も表示
                editorCtx.strokeStyle = '#673ab7';
                editorCtx.lineWidth = 2;
                editorCtx.setLineDash([5, 5]);
                editorCtx.strokeRect(
                    Math.min(startX, currentX),
                    Math.min(startY, currentY),
                    Math.abs(currentX - startX),
                    Math.abs(currentY - startY)
                );
                editorCtx.setLineDash([]);
                editorCtx.restore();
            };
            
            editorCanvas.onmouseup = function(e) {
                if (!isDrawing) return;
                isDrawing = false;
                
                const rect = editorCanvas.getBoundingClientRect();
                const scaleX = editorCanvas.width / rect.width;
                const scaleY = editorCanvas.height / rect.height;
                
                const endX = (e.clientX - rect.left) * scaleX;
                const endY = (e.clientY - rect.top) * scaleY;
                
                // 選択範囲が十分大きい場合のみマスク適用
                if (Math.abs(endX - startX) > 10 && Math.abs(endY - startY) > 10) {
                    // マスクの座標情報を履歴に保存
                    const maskData = {
                        x: Math.min(startX, endX),
                        y: Math.min(startY, endY),
                        width: Math.abs(endX - startX),
                        height: Math.abs(endY - startY)
                    };
                    editHistory.push(maskData);
                    
                    // 黒いマスク適用
                    applyBlackMask(maskData.x, maskData.y, maskData.width, maskData.height);
                }
                
                redrawCanvas();
            };
        }
        
        function redrawCanvas() {
            // 元画像を描画
            editorCtx.putImageData(originalImageData, 0, 0);
            
            // 履歴にある全てのマスクを現在の透明度で再描画
            const currentOpacity = parseInt(document.getElementById('maskOpacity').value) / 100;
            if (editHistory.length > 0) {
                editHistory.forEach(mask => {
                    editorCtx.save();
                    editorCtx.fillStyle = `rgba(0, 0, 0, ${currentOpacity})`;
                    editorCtx.fillRect(mask.x, mask.y, mask.width, mask.height);
                    editorCtx.restore();
                });
            }
        }
        
        function applyBlackMask(x, y, width, height) {
            const opacity = parseInt(document.getElementById('maskOpacity').value) / 100;
            
            // 現在の描画状態を保存
            editorCtx.save();
            
            // 黒い長方形を描画
            editorCtx.fillStyle = `rgba(0, 0, 0, ${opacity})`;
            editorCtx.fillRect(x, y, width, height);
            
            // 描画状態を復元
            editorCtx.restore();
        }
        
        function undoLastMask() {
            if (editHistory.length > 0) {
                editHistory.pop();
                redrawCanvas();
            }
        }
        
        function clearAllMasks() {
            editHistory = [];
            redrawCanvas();
        }
        
        function applyImageEdits() {
            // 編集された画像をBlobに変換
            editorCanvas.toBlob(function(blob) {
                // 新しいFileオブジェクトを作成
                const editedFile = new File([blob], currentEditingInput.files[0].name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                
                // FileListを模擬的に作成
                const dt = new DataTransfer();
                dt.items.add(editedFile);
                currentEditingInput.files = dt.files;
                
                // プレビューを更新
                const preview = document.getElementById(currentPreviewId);
                preview.src = editorCanvas.toDataURL('image/jpeg', 0.9);
                
                closeImageEditor();
            }, 'image/jpeg', 0.9);
        }
        
        function closeImageEditor() {
            const modal = document.getElementById('imageEditorModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            currentEditingInput = null;
            currentPreviewId = null;
            originalImageData = null;
            editHistory = [];
        }
        
        function checkDuplicateCustomer() {
            const customerNumber = document.getElementById('customerNumber').value.trim();
            const checkResult = document.getElementById('customerCheckResult');
            const checkButton = document.getElementById('checkButton');
            
            if (!customerNumber) {
                clearCustomerCheck();
                return;
            }
            
            // ボタンを無効化
            checkButton.disabled = true;
            checkButton.textContent = 'チェック中...';
            
            // LocalStorageから既存の症例データを取得
            const cases = JSON.parse(localStorage.getItem('floraskinCases') || '[]');
            const existingCase = cases.find(caseData => caseData.customerNumber === customerNumber);
            
            setTimeout(() => {
                checkButton.disabled = false;
                checkButton.textContent = '重複チェック';
                
                if (existingCase) {
                    // 既存の症例が見つかった場合
                    checkResult.className = 'customer-check warning';
                    checkResult.innerHTML = `
                        <strong>⚠️ この顧客番号は既に登録されています</strong>
                        既存の症例情報が見つかりました。前回のデータを自動反映することができます。
                        <div class="customer-check-actions">
                            <a href="#" onclick="loadPreviousData('${existingCase.id}')">前回データを読み込む</a>
                            <a href="update.html?customerNumber=${encodeURIComponent(customerNumber)}" target="_blank">既存症例を更新する</a>
                            <a href="#" onclick="continueWithNewCase()">新規として登録する</a>
                        </div>
                    `;
                    checkResult.style.display = 'block';
                } else {
                    // 重複なしの場合
                    checkResult.className = 'customer-check success';
                    checkResult.innerHTML = `
                        <strong>✅ この顧客番号は使用可能です</strong>
                        新規症例として登録できます。
                    `;
                    checkResult.style.display = 'block';
                }
            }, 800);
        }
        
        function clearCustomerCheck() {
            const checkResult = document.getElementById('customerCheckResult');
            checkResult.style.display = 'none';
            checkResult.innerHTML = '';
        }
        
        function continueWithNewCase() {
            const checkResult = document.getElementById('customerCheckResult');
            checkResult.className = 'customer-check error';
            checkResult.innerHTML = `
                <strong>⚠️ 注意：同じ顧客番号で複数の症例が登録されます</strong>
                続行する場合は、後で症例の整理が必要になる可能性があります。
            `;
        }
        
        function loadPreviousData(caseId) {
            const cases = JSON.parse(localStorage.getItem('floraskinCases') || '[]');
            
            // 同じ顧客番号の全ての症例を取得
            const customerNumber = document.getElementById('customerNumber').value.trim();
            const customerCases = cases.filter(c => c.customerNumber === customerNumber);
            
            if (customerCases.length === 0) {
                alert('前回のデータが見つかりませんでした。');
                return;
            }
            
            // 最新の症例データを取得（タイムスタンプの新しい順）
            const existingCase = customerCases.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
            
            console.log('最新の症例データを読み込みます:', existingCase);
            
            // 基本情報を反映（顧客番号以外）
            document.getElementById('store').value = existingCase.store || '';
            document.getElementById('staffName').value = existingCase.staffName || '';
            document.getElementById('birthDate').value = existingCase.birthDate || '';
            document.getElementById('concern').value = existingCase.concern || '';
            
            // 生年月日から年齢層を再計算
            if (existingCase.birthDate) {
                calculateAgeGroup();
            }
            
            // 症例区分を反映
            document.getElementById('normalCase').checked = existingCase.normalCase || false;
            document.getElementById('adverseReaction').checked = existingCase.adverseReaction || false;
            document.getElementById('complaint').checked = existingCase.complaint || false;
            
            // 施術情報を反映
            document.getElementById('frequency').value = existingCase.frequency || '';
            document.getElementById('period').value = existingCase.period || '';
            
            // 詳細情報を反映
            document.getElementById('treatmentNotes').value = existingCase.treatmentNotes || '';
            document.getElementById('lifestyle').value = existingCase.lifestyle || '';
            document.getElementById('progress').value = existingCase.progress || '';
            document.getElementById('innovations').value = existingCase.innovations || '';
            document.getElementById('futureCare').value = existingCase.futureCare || '';
            document.getElementById('additionalNotes').value = existingCase.additionalNotes || '';
            
            // 利用許可を反映
            document.getElementById('secondaryUse').value = existingCase.secondaryUse || '';
            if (existingCase.secondaryUseNote) {
                document.getElementById('secondaryUseNote').value = existingCase.secondaryUseNote;
                toggleSecondaryUseNote(); // 備考欄の表示制御
            }
            
            // 既存の施術履歴を表示（読み取り専用として）
            if (existingCase.images && existingCase.images.length > 0) {
                // 既存の画像セクションをクリア
                const imageSections = document.getElementById('imageSections');
                imageSections.innerHTML = '';
                
                // 既存画像を表示
                existingCase.images.forEach(imageData => {
                    addImageSection();
                    const sessionNumber = imageData.session;
                    
                    // セッション情報を設定
                    const dateInput = document.getElementById(`sessionDate${sessionNumber}`);
                    const menuInput = document.getElementById(`sessionMenu${sessionNumber}`);
                    const solutionInput = document.getElementById(`sessionSolution${sessionNumber}`);
                    const notesInput = document.getElementById(`sessionNotes${sessionNumber}`);
                    
                    if (dateInput) dateInput.value = imageData.date || '';
                    if (menuInput) menuInput.value = imageData.menu || '';
                    if (solutionInput) solutionInput.value = imageData.solution || '';
                    if (notesInput) notesInput.value = imageData.notes || '';
                });
                
                imageSessionCount = existingCase.images.length;
            }
            
            // 新しい施術回として設定（前回の回数+1から開始）
            const newSessionCount = (existingCase.sessionCount || 0) + 1;
            document.getElementById('sessionCount').value = newSessionCount;
            
            // 新しい画像セクションを追加
            addImageSection();
            imageSessionCount = Math.max(imageSessionCount, newSessionCount);
            
            // 結果メッセージを表示
            const checkResult = document.getElementById('customerCheckResult');
            checkResult.className = 'customer-check success';
            checkResult.innerHTML = `
                <strong>✅ 前回データを読み込みました</strong>
                ${existingCase.staffName}さんの${existingCase.sessionCount}回目の症例データを基に、${newSessionCount}回目として新規登録します。<br>
                既存の施術履歴も表示されました。必要に応じて情報を修正してください。
            `;
            
            // スクロールして施術情報セクションへ移動
            document.querySelector('.form-section:nth-of-type(2)').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        document.getElementById('caseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // フォームデータの収集
            const formData = new FormData(this);
            const data = {};
            
            // テキストデータの収集
            for (let [key, value] of formData.entries()) {
                if (!key.includes('before') && !key.includes('after') && 
                    !key.includes('sessionDate') && !key.includes('sessionMenu') && 
                    !key.includes('sessionSolution') && !key.includes('sessionNotes')) {
                    data[key] = value;
                }
            }
            
            // チェックボックスの値を明示的に設定
            data.normalCase = document.getElementById('normalCase').checked;
            data.adverseReaction = document.getElementById('adverseReaction').checked;
            data.complaint = document.getElementById('complaint').checked;
            
            // 画像データの処理（実際の実装では、画像をBase64に変換してLocalStorageに保存）
            data.images = [];
            
            for (let i = 1; i <= imageSessionCount; i++) {
                const sessionDateInput = document.getElementById(`sessionDate${i}`);
                const sessionMenuSelect = document.getElementById(`sessionMenu${i}`);
                const sessionSolutionSelect = document.getElementById(`sessionSolution${i}`);
                const sessionNotesInput = document.getElementById(`sessionNotes${i}`);
                
                // 4段構成の画像データを収集
                const frontBeforeInput = document.getElementById(`frontBefore${i}`);
                const frontAfterInput = document.getElementById(`frontAfter${i}`);
                const rightBeforeInput = document.getElementById(`rightBefore${i}`);
                const rightAfterInput = document.getElementById(`rightAfter${i}`);
                const leftBeforeInput = document.getElementById(`leftBefore${i}`);
                const leftAfterInput = document.getElementById(`leftAfter${i}`);
                const otherBeforeInput = document.getElementById(`otherBefore${i}`);
                const otherAfterInput = document.getElementById(`otherAfter${i}`);
                
                // セッション情報と画像データを収集
                const sessionDate = sessionDateInput ? sessionDateInput.value : null;
                const sessionMenu = sessionMenuSelect ? sessionMenuSelect.value : null;
                const sessionSolution = sessionSolutionSelect ? sessionSolutionSelect.value : null;
                const sessionNotes = sessionNotesInput ? sessionNotesInput.value : null;
                
                // 画像ファイルのチェック
                const frontBeforeFile = frontBeforeInput ? frontBeforeInput.files[0] : null;
                const frontAfterFile = frontAfterInput ? frontAfterInput.files[0] : null;
                const rightBeforeFile = rightBeforeInput ? rightBeforeInput.files[0] : null;
                const rightAfterFile = rightAfterInput ? rightAfterInput.files[0] : null;
                const leftBeforeFile = leftBeforeInput ? leftBeforeInput.files[0] : null;
                const leftAfterFile = leftAfterInput ? leftAfterInput.files[0] : null;
                const otherBeforeFile = otherBeforeInput ? otherBeforeInput.files[0] : null;
                const otherAfterFile = otherAfterInput ? otherAfterInput.files[0] : null;
                
                // 何かのデータが入力されている場合のみ保存
                if (frontBeforeFile || frontAfterFile || rightBeforeFile || rightAfterFile || 
                    leftBeforeFile || leftAfterFile || otherBeforeFile || otherAfterFile ||
                    sessionDate || sessionMenu || sessionSolution || sessionNotes) {
                    
                    data.images.push({
                        session: i,
                        date: sessionDate,
                        menu: sessionMenu,
                        solution: sessionSolution,
                        notes: sessionNotes,
                        // 4段構成の画像情報
                        frontBefore: frontBeforeFile ? frontBeforeFile.name : null,
                        frontAfter: frontAfterFile ? frontAfterFile.name : null,
                        rightBefore: rightBeforeFile ? rightBeforeFile.name : null,
                        rightAfter: rightAfterFile ? rightAfterFile.name : null,
                        leftBefore: leftBeforeFile ? leftBeforeFile.name : null,
                        leftAfter: leftAfterFile ? leftAfterFile.name : null,
                        otherBefore: otherBeforeFile ? otherBeforeFile.name : null,
                        otherAfter: otherAfterFile ? otherAfterFile.name : null,
                        // 互換性のために旧フォーマットも保持
                        before: frontBeforeFile ? frontBeforeFile.name : null,
                        after: frontAfterFile ? frontAfterFile.name : null
                    });
                }
            }
            
            // sessionCountを実際の画像セクション数に更新
            data.sessionCount = imageSessionCount;
            
            // タイムスタンプ追加
            data.timestamp = new Date().toISOString();
            data.id = Date.now().toString();
            
            // LocalStorageに保存
            const cases = JSON.parse(localStorage.getItem('floraskinCases') || '[]');
            cases.push(data);
            localStorage.setItem('floraskinCases', JSON.stringify(cases));
            
            // 成功メッセージ表示後、一覧ページへ遷移
            alert('症例を投稿しました！');
            window.location.href = 'cases.html';
        });
    </script>
    
    <!-- 画像編集モーダル -->
    <div class="image-editor-modal" id="imageEditorModal">
        <div class="image-editor-content">
            <div class="editor-header">
                <div class="editor-title">画像編集 - 目隠し処理</div>
                <button class="editor-close" onclick="closeImageEditor()">&times;</button>
            </div>
            
            <div class="editor-canvas-container">
                <canvas id="imageEditorCanvas" class="editor-canvas"></canvas>
            </div>
            
            <div class="editor-controls">
                <div class="opacity-container">
                    <label for="maskOpacity">透明度:</label>
                    <input type="range" id="maskOpacity" class="opacity-slider" min="70" max="100" value="100">
                    <span id="maskOpacityValue">100</span>%
                </div>
                
                <button class="editor-button secondary" onclick="undoLastMask()">元に戻す</button>
                <button class="editor-button secondary" onclick="clearAllMasks()">全てクリア</button>
                <button class="editor-button primary" onclick="applyImageEdits()">適用</button>
                <button class="editor-button secondary" onclick="closeImageEditor()">キャンセル</button>
                
                <div class="selection-info">
                    マウスでドラッグして目隠しをかけたい範囲を選択してください
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ページ読み込み時の認証チェック
        window.onload = function() {
            checkAuthentication();
        };
        
        function checkAuthentication() {
            const loginInfo = localStorage.getItem('floraskinLogin');
            if (!loginInfo) {
                window.location.href = 'login.html';
                return;
            }
            
            const login = JSON.parse(loginInfo);
            document.getElementById('userInfo').textContent = `${login.store} (${login.userId})`;
            
            // 店舗を自動選択
            const storeSelect = document.getElementById('store');
            if (storeSelect) {
                storeSelect.value = login.store;
                storeSelect.disabled = login.role !== 'admin'; // 管理者以外は変更不可
            }
        }
        
        function logout() {
            if (confirm('ログアウトしますか？')) {
                localStorage.removeItem('floraskinLogin');
                window.location.href = 'login.html';
            }
        }
    </script>
    
</body>
</html>